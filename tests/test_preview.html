<!DOCTYPE html>
<html>
<head>
    <title>Preview Test</title>
    <style>
        .message-thumbnail {
            max-width: 150px;
            max-height: 150px;
            display: block;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="test-dom" style="display:none">
        <form id="chat-form">
            <input type="file" id="file-upload">
            <textarea id="message-input"></textarea>
            <div id="file-preview-area"></div>
            <div id="file-name"></div>
            <button id="clear-file-btn"></button>
            <input type="hidden" id="model-input">
        </form>
        <div id="chat-container"></div>
        <button id="reset-btn"></button>
        <div id="patterns-list"></div>
        <input id="pattern-search">
        <div id="patternsModal"></div>
        <div id="sessions-list"></div>
        <button id="new-chat-btn"></button>
        <div id="historySidebar"></div>
        <div id="toolsModal"></div>
        <div id="tools-status"></div>
        <button id="btn-apply-tools"></button>
        <button id="btn-deselect-all-tools"></button>
        <div id="liveToast"></div>
        <div id="toast-body"></div>
        <div id="load-more-container"></div>
        <button id="load-more-btn"></button>
        <div id="chat-welcome"></div>
        <div id="model-label"></div>
    </div>

    <script>
        // Mock globals
        window.bootstrap = {
            Offcanvas: { getInstance: () => ({ hide: () => {} }) },
            Modal: { getInstance: () => ({ hide: () => {} }) },
            Toast: function() { return { show: () => {} }; }
        };
        window.marked = { parse: (t) => t };
        window.hljs = { highlightElement: () => {} };
        window.fetch = async () => ({
            ok: true,
            json: async () => []
        });
    </script>
    
    <script src="../app/static/script.js"></script>

    <script>
        function runTests() {
            const results = [];
            const chatContainer = document.getElementById('chat-container');
            
            try {
                // Test 1: Historical message with image path
                const historyText = "@tmp/user_attachments/test.webp describe this";
                const msgDiv = createMessageDiv('user', historyText);
                chatContainer.appendChild(msgDiv);
                
                const img = msgDiv.querySelector('img.message-thumbnail');
                if (img) {
                    if (img.src.includes('/uploads/test.webp')) {
                        results.push({ name: 'History image preview', status: 'pass' });
                    } else {
                        results.push({ name: 'History image preview', status: 'fail', error: 'Wrong image src: ' + img.src });
                    }
                } else {
                    results.push({ name: 'History image preview', status: 'fail', error: 'Image tag not found' });
                }

                // Test 2: New upload with File object
                const file = new File(["test"], "new.png", { type: "image/png" });
                const msgDiv2 = createMessageDiv('user', "here is a new image", "Attachment: new.png", file);
                chatContainer.appendChild(msgDiv2);
                
                const img2 = msgDiv2.querySelector('img.message-thumbnail');
                if (img2) {
                    if (img2.src.startsWith('blob:')) {
                        results.push({ name: 'New upload image preview', status: 'pass' });
                    } else {
                        results.push({ name: 'New upload image preview', status: 'fail', error: 'Expected blob URL but got: ' + img2.src });
                    }
                } else {
                    results.push({ name: 'New upload image preview', status: 'fail', error: 'Image tag not found for new upload' });
                }

            } catch (e) {
                results.push({ name: 'Test execution', status: 'fail', error: e.message });
            }

            const resDiv = document.createElement('div');
            resDiv.id = 'results';
            resDiv.innerText = JSON.stringify(results);
            document.body.appendChild(resDiv);
        }
        
        setTimeout(runTests, 1000);
    </script>
</body>
</html>

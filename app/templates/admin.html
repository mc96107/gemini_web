<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Gemini Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="icon" type="image/svg+xml" href="/static/icon.svg?v=2">
    <style>
        body { background-color: #121212; color: #e0e0e0; }
        .card { background-color: #1e1e1e; border: 1px solid #333; }
        .table { color: #e0e0e0; }
        .table-hover tbody tr:hover { background-color: #2c2c2c; }
        h2, h5, .card-title { color: #fff !important; }
        .text-muted { color: #aaa !important; }
        .form-label { color: #ccc !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-robot text-primary me-2"></i>Gemini Agent Admin</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Back to Chat</a>
                <a class="nav-link" href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="mb-4">User Management</h2>

        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Users</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th>Pattern Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr>
                                        <td>{{ user.username }}</td>
                                        <td>
                                            <div class="dropdown">
                                                <button class="btn btn-sm {{ 'btn-primary' if user.role == 'admin' else 'btn-secondary' }} dropdown-toggle py-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 0.75rem;">
                                                    {{ user.role }}
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-dark shadow">
                                                    <li><a class="dropdown-item small" href="#" onclick="changeRole('{{ user.username }}', 'user')">User</a></li>
                                                    <li><a class="dropdown-item small" href="#" onclick="changeRole('{{ user.username }}', 'admin')">Admin</a></li>
                                                </ul>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" role="switch" 
                                                    id="patternSwitch_{{ user.username }}" 
                                                    {% if not user.pattern_disabled %}checked{% endif %}
                                                    onchange="togglePattern('{{ user.username }}', this.checked)">
                                                <label class="form-check-label" for="patternSwitch_{{ user.username }}">
                                                    {{ 'Enabled' if not user.pattern_disabled else 'Disabled' }}
                                                </label>
                                            </div>
                                        </td>
                                        <td>
                                            {% if user.username != 'admin' %}
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('{{ user.username }}')">Delete</button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-info" onclick="showChangePassword('{{ user.username }}')">Change Password</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">System Actions</h5>
                        <button class="btn btn-info w-100 mb-2" onclick="syncPatterns()">
                            <i class="bi bi-arrow-repeat me-1"></i> Sync Fabric Patterns
                        </button>
                        <button class="btn btn-outline-danger w-100 mb-2" onclick="clearAllTags()">
                            <i class="bi bi-trash me-1"></i> Clear All Chat Tags
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="restartSetup()">
                            <i class="bi bi-exclamation-triangle me-1"></i> Restart Setup
                        </button>
                        <div class="mt-3">
                            <label class="form-label small text-muted">Logging Level</label>
                            <select id="log-level-select" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="updateLogLevel(this.value)">
                                <option value="NONE">NONE (Silent)</option>
                                <option value="INFO">INFO (Normal)</option>
                                <option value="DEBUG">DEBUG (Verbose)</option>
                            </select>
                        </div>
                        <div id="sync-status" class="small mt-2"></div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Global Settings</h5>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label small text-muted mb-0">Prompt Helper Instructions</label>
                                <button class="btn btn-link btn-sm text-warning p-0" style="text-decoration: none; font-size: 0.7rem;" onclick="resetPromptHelperInstructions()">
                                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                                </button>
                            </div>
                            <textarea id="prompt-helper-instructions" class="form-control form-control-sm bg-dark text-light border-secondary" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label small text-muted mb-0">Interactive Mode Instructions</label>
                                <button class="btn btn-link btn-sm text-warning p-0" style="text-decoration: none; font-size: 0.7rem;" onclick="resetInteractiveModeInstructions()">
                                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                                </button>
                            </div>
                            <textarea id="interactive-mode-instructions" class="form-control form-control-sm bg-dark text-light border-secondary" rows="4"></textarea>
                        </div>
                        <button class="btn btn-primary btn-sm w-100" onclick="saveGlobalSettings()">
                            Save All Settings
                        </button>
                        <div id="settings-status" class="small mt-2"></div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Add User</h5>
                        <form action="/admin/user/add" method="post">
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" name="username" class="form-control bg-dark text-light border-secondary" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" name="password" class="form-control bg-dark text-light border-secondary" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Role</label>
                                <select name="role" class="form-select bg-dark text-light border-secondary">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success w-100">Add User</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <hr class="border-secondary my-5">

        <h2 class="mb-4">Agent Management</h2>
        
        <div id="orchestration-warnings" class="mb-3"></div>

        <div class="row">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Agents</h5>
                            <div class="d-flex gap-2">
                                <select id="categoryFilter" class="form-select form-select-sm bg-dark text-light border-secondary" style="width: auto;" onchange="renderAgents()">
                                    <option value="all">All Categories</option>
                                </select>
                                <button class="btn btn-sm btn-outline-info" onclick="editRootAgent()">
                                    <i class="bi bi-gear-fill me-1"></i> Root Orchestrator
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="showAgentEditor()">
                                    <i class="bi bi-plus-lg me-1"></i> New Agent
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Enabled</th>
                                        <th>Name</th>
                                        <th>Folder</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agentsTableBody">
                                    <!-- Loaded via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        </div>
    </div>

    <!-- Agent Editor Modal -->
    <div class="modal fade" id="agentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="agentModalTitle">New Agent</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="agentForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <input type="text" id="agentCategory" class="form-control bg-dark text-light border-secondary" placeholder="e.g., functions, projects" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Folder Name</label>
                                <input type="text" id="agentFolder" class="form-control bg-dark text-light border-secondary" placeholder="e.g., team_manager" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" id="agentName" class="form-control bg-dark text-light border-secondary" placeholder="Display Name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" id="agentDescription" class="form-control bg-dark text-light border-secondary" placeholder="Brief description">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">System Prompt (Markdown)</label>
                            <textarea id="agentPrompt" class="form-control bg-dark text-light border-secondary" rows="10" placeholder="Agent instructions..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Associated Skills</label>
                            <div id="skillsContainer" class="d-flex flex-wrap gap-2">
                                <!-- Loaded via JS -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAgent()">Save Agent</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Change Password for <span id="targetUsername"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/admin/user/update-password" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="username" id="modalUsername">
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" name="new_password" class="form-control bg-dark text-light border-secondary" required>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Available Skills</h5>
                        <button class="btn btn-primary btn-sm" onclick="showNewSkill()">
                            <i class="bi bi-plus-lg me-1"></i> Add Skill
                        </button>
                    </div>
                    <p class="text-muted small">Managed in <code>.agents/skills/</code></p>
                    <div id="dashboardSkillsList" class="list-group list-group-flush bg-dark">
                        <!-- Loaded via JS -->
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">MCP Servers</h5>
                        <button class="btn btn-primary btn-sm" onclick="showNewMCP()">
                            <i class="bi bi-plus-lg me-1"></i> Add MCP Server
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Name</th>
                                    <th>Command</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mcpTableBody">
                                <!-- Loaded via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MCP Modal -->
    <div class="modal fade" id="mcpModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="mcpModalTitle">Add MCP Server</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="mcpForm">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" id="mcpName" class="form-control bg-dark text-light border-secondary" placeholder="e.g., sqlite-server" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Command</label>
                            <input type="text" id="mcpCommand" class="form-control bg-dark text-light border-secondary" placeholder="e.g., npx" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Arguments (Space separated)</label>
                            <input type="text" id="mcpArgs" class="form-control bg-dark text-light border-secondary" placeholder="e.g., -y @modelcontextprotocol/server-sqlite --db /path/to/db">
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMCP()">Add Server</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Skill Modal -->
    <div class="modal fade" id="skillModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="skillModalTitle">New Skill</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="skillForm">
                        <div class="mb-3">
                            <label class="form-label">Skill Name (Filename)</label>
                            <input type="text" id="skillName" class="form-control bg-dark text-light border-secondary" placeholder="e.g., code-reviewer" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Instructions (Markdown)</label>
                            <textarea id="skillContent" class="form-control bg-dark text-light border-secondary" rows="15" placeholder="# Skill: ...\n\n## Instructions\n..." required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSkill()">Save Skill</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
        const agentModal = new bootstrap.Modal(document.getElementById('agentModal'));
        const mcpModal = new bootstrap.Modal(document.getElementById('mcpModal'));
        const skillModal = new bootstrap.Modal(document.getElementById('skillModal'));
        let allAgents = [];
        let allSkills = [];

        document.addEventListener('DOMContentLoaded', () => {
            const logLevel = "{{ log_level }}";
            const select = document.getElementById('log-level-select');
            if (select) select.value = logLevel;
            fetchAgents();
            fetchMCP();
            fetchSkills();
            fetchGlobalSettings();
        });

        async function fetchSkills() {
            try {
                const res = await fetch('/admin/skills');
                allSkills = await res.json();
                
                const list = document.getElementById('dashboardSkillsList');
                if (list) {
                    list.innerHTML = '';
                    allSkills.forEach(skill => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item bg-dark text-light border-secondary d-flex justify-content-between align-items-center py-1';
                        item.innerHTML = `
                            <span><i class="bi bi-magic me-2 text-info"></i>${skill}</span>
                            <div>
                                <button class="btn btn-sm btn-link text-info p-0 me-2" onclick="editSkill('${skill}')"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteSkill('${skill}')"><i class="bi bi-trash"></i></button>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                    if (allSkills.length === 0) {
                        list.innerHTML = '<div class="text-muted small p-2">No skills found.</div>';
                    }
                }
            } catch (err) { console.error('Error fetching skills:', err); }
        }

        function showNewSkill() {
            document.getElementById('skillModalTitle').textContent = 'New Skill';
            document.getElementById('skillName').value = '';
            document.getElementById('skillName').disabled = false;
            document.getElementById('skillContent').value = '# Skill: ...\n\n## Instructions\n...';
            skillModal.show();
        }

        async function editSkill(name) {
            try {
                const res = await fetch(`/admin/skills/${name}`);
                const skill = await res.json();
                document.getElementById('skillModalTitle').textContent = 'Edit Skill';
                document.getElementById('skillName').value = skill.name;
                document.getElementById('skillName').disabled = true;
                document.getElementById('skillContent').value = skill.content;
                skillModal.show();
            } catch (err) { alert('Error loading skill'); }
        }

        async function saveSkill() {
            const name = document.getElementById('skillName').value.trim();
            const content = document.getElementById('skillContent').value.trim();
            if (!name || !content) return;

            try {
                const res = await fetch('/admin/skills', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, content})
                });
                const data = await res.json();
                if (data.success) {
                    skillModal.hide();
                    fetchSkills();
                } else { alert('Error saving skill'); }
            } catch (err) { alert('Request failed'); }
        }

        async function deleteSkill(name) {
            if (!confirm(`Are you sure you want to delete skill "${name}"?`)) return;
            try {
                const res = await fetch(`/admin/skills/${name}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    fetchSkills();
                } else { alert('Error deleting skill'); }
            } catch (err) { alert('Request failed'); }
        }

        function renderSkillsCheckboxes(selectedSkills = []) {
            const container = document.getElementById('skillsContainer');
            container.innerHTML = '';
            
            if (allSkills.length === 0) {
                container.innerHTML = '<span class="text-muted small">No skills found in .agents/skills/</span>';
                return;
            }

            allSkills.forEach(skill => {
                const div = document.createElement('div');
                div.className = 'form-check form-check-inline';
                const checked = selectedSkills.includes(skill) ? 'checked' : '';
                div.innerHTML = `
                    <input class="form-check-input skill-checkbox" type="checkbox" value="${skill}" id="skill_${skill}" ${checked}>
                    <label class="form-check-label small" for="skill_${skill}">${skill}</label>
                `;
                container.appendChild(div);
            });
        }

        async function fetchMCP() {
            try {
                const res = await fetch('/admin/mcp');
                const servers = await res.json();
                const tbody = document.getElementById('mcpTableBody');
                tbody.innerHTML = '';
                
                servers.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" ${s.enabled ? 'checked' : ''} 
                                    onchange="toggleMCP('${s.name}', this.checked)">
                                <span class="badge ${s.status === 'Connected' ? 'bg-success' : 'bg-secondary'} ms-1" style="font-size: 0.6rem;">${s.status}</span>
                            </div>
                        </td>
                        <td><strong>${s.name}</strong></td>
                        <td><code>${s.command}</code></td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeMCP('${s.name}')"><i class="bi bi-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Error fetching MCP servers:', err);
            }
        }

        function showNewMCP() {
            document.getElementById('mcpForm').reset();
            mcpModal.show();
        }

        async function saveMCP() {
            const name = document.getElementById('mcpName').value;
            const command = document.getElementById('mcpCommand').value;
            const args = document.getElementById('mcpArgs').value;
            
            if (!name || !command) return;
            
            try {
                const res = await fetch('/admin/mcp/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, command, args})
                });
                const data = await res.json();
                if (data.success) {
                    mcpModal.hide();
                    fetchMCP();
                } else {
                    alert('Error adding MCP: ' + data.output);
                }
            } catch (err) {
                alert('Request failed');
            }
        }

        async function removeMCP(name) {
            if (!confirm(`Are you sure you want to remove MCP server "${name}"?`)) return;
            try {
                const res = await fetch('/admin/mcp/remove', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name})
                });
                const data = await res.json();
                if (data.success) {
                    fetchMCP();
                } else {
                    alert('Error removing MCP: ' + data.output);
                }
            } catch (err) {
                alert('Request failed');
            }
        }

        async function toggleMCP(name, enabled) {
            try {
                const res = await fetch('/admin/mcp/toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, enabled})
                });
                const data = await res.json();
                if (!data.success) {
                    alert('Error toggling MCP: ' + data.output);
                    fetchMCP(); // Revert UI
                }
            } catch (err) {
                alert('Request failed');
                fetchMCP();
            }
        }

        async function fetchAgents() {
            try {
                const res = await fetch('/admin/agents');
                allAgents = await res.json();
                updateCategoryFilter();
                renderAgents();
                validateOrchestration();
            } catch (e) { console.error('Error fetching agents:', e); }
        }

        async function fetchGlobalSettings() {
            try {
                const res = await fetch('/admin/settings');
                const data = await res.json();
                if (data.prompt_helper_instructions) {
                    document.getElementById('prompt-helper-instructions').value = data.prompt_helper_instructions;
                }
                if (data.interactive_mode_instructions) {
                    document.getElementById('interactive-mode-instructions').value = data.interactive_mode_instructions;
                }
            } catch (e) { console.error('Error fetching settings:', e); }
        }

        async function saveGlobalSettings() {
            const status = document.getElementById('settings-status');
            const helperInstructions = document.getElementById('prompt-helper-instructions').value;
            const interactiveInstructions = document.getElementById('interactive-mode-instructions').value;
            
            status.textContent = 'Saving...';
            status.className = 'small mt-2 text-info';

            try {
                const res = await fetch('/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt_helper_instructions: helperInstructions,
                        interactive_mode_instructions: interactiveInstructions
                    })
                });
                const data = await res.json();
                if (data.success) {
                    status.textContent = 'Settings saved successfully!';
                    status.className = 'small mt-2 text-success';
                    setTimeout(() => { status.textContent = ''; }, 3000);
                } else {
                    status.textContent = 'Error saving settings';
                    status.className = 'small mt-2 text-danger';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'small mt-2 text-danger';
            }
        }

        function resetPromptHelperInstructions() {
            const defaultInstructions = `You are an expert prompt engineer. Your goal is to help the user build a high-quality, effective prompt through a guided interaction.
Based on the information gathered so far, your task is to ask the NEXT logical question to further refine the prompt.

If 'ACTIVE CHAT CONTEXT' is provided, use it to infer the user's likely goal and skip initial general questions (like "What is the topic?"). Instead, ask a more specific starting question relevant to that context.

Output your response EXCLUSIVELY in JSON format with the following keys:
- "question": The question to ask the user.
- "options": A list of suggested short answers (buttons), or an empty list [] if it's an open-ended question.
- "allow_multiple": Boolean, true if the user should be allowed to select multiple options.
- "reasoning": A brief explanation of why you are asking this question.
- "is_complete": Boolean, true if you have enough information to synthesize the final prompt.

Guidelines:
- Keep questions concise and focused.
- Provide 2-4 options when possible.
- Set "allow_multiple" to true if the question asks for "all that apply" or features/topics.
- DO NOT loop indefinitely. If you have a clear idea of the role, goal, and constraints, set 'is_complete' to true.
- If 'is_complete' is true, set 'question' to "I have gathered enough information to build your prompt. Would you like to review it now?" and provide options ["Yes", "Not yet, I want to add more"].`;
            
            document.getElementById('prompt-helper-instructions').value = defaultInstructions;
        }

        function resetInteractiveModeInstructions() {
            const defaultInstructions = `You can ask interactive multiple-choice or open-ended questions to the user in their preferred language (e.g., Greek).
To trigger a question card, include a JSON block in your response using this format:
{"type": "question", "question": "Your question text here", "options": ["Option 1", "Option 2"], "allow_multiple": false}
- The 'question' and 'options' values should match the language of the conversation.
- If 'allow_multiple' is true, users can select several options.
- If 'options' is empty [], it is an open-ended question.
The user's response will be sent back to you as a normal message.`;
            
            document.getElementById('interactive-mode-instructions').value = defaultInstructions;
        }

        function updateCategoryFilter() {
            const filter = document.getElementById('categoryFilter');
            const categories = [...new Set(allAgents.map(a => a.category))].sort();
            
            // Keep "All Categories"
            filter.innerHTML = '<option value="all">All Categories</option>';
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                filter.appendChild(opt);
            });
        }

        function renderAgents() {
            const filter = document.getElementById('categoryFilter').value;
            const tbody = document.getElementById('agentsTableBody');
            tbody.innerHTML = '';

            const filtered = filter === 'all' ? allAgents : allAgents.filter(a => a.category === filter);

            filtered.forEach(agent => {
                const tr = document.createElement('tr');
                const isEnabled = agent.parent !== null && agent.parent !== undefined;
                const isRoot = agent.category === 'root';
                
                tr.innerHTML = `
                    <td><span class="badge bg-secondary">${agent.category}</span></td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" 
                                id="agentEnabled_${agent.category}_${agent.folder_name}" 
                                ${isEnabled ? 'checked' : ''}
                                ${isRoot ? 'disabled' : ''}
                                onchange="toggleAgentEnabled('${agent.category}', '${agent.folder_name}', this.checked)">
                        </div>
                    </td>
                    <td><strong>${agent.name}</strong></td>
                    <td><code>${agent.folder_name}</code></td>
                    <td class="small text-muted">${agent.description || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="editAgent('${agent.category}', '${agent.folder_name}')">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAgent('${agent.category}', '${agent.folder_name}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function toggleAgentEnabled(category, name, enabled) {
            try {
                const res = await fetch(`/admin/agents/${category}/${name}/toggle-enabled`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                const result = await res.json();
                if (result.success) {
                    validateOrchestration();
                } else {
                    alert('Error toggling agent status');
                    document.getElementById(`agentEnabled_${category}_${name}`).checked = !enabled;
                }
            } catch (e) {
                console.error(e);
                alert('Error');
                document.getElementById(`agentEnabled_${category}_${name}`).checked = !enabled;
            }
        }

        async function validateOrchestration() {
            try {
                const res = await fetch('/admin/agents/validate');
                const data = await res.json();
                const container = document.getElementById('orchestration-warnings');
                container.innerHTML = '';
                
                if (data.warnings && data.warnings.length > 0) {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-warning border-warning bg-dark-subtle py-2 mb-0';
                    alert.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>
                            <div>
                                <h6 class="alert-heading mb-1 small fw-bold">Orchestration Warnings</h6>
                                <ul class="mb-0 small ps-3">
                                    ${data.warnings.map(w => `<li>${w}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                    container.appendChild(alert);
                }
            } catch (e) { console.error('Validation error:', e); }
        }

        function showAgentEditor(agent = null) {
            const isEdit = !!agent;
            document.getElementById('agentModalTitle').textContent = isEdit ? 'Edit Agent' : 'New Agent';
            document.getElementById('agentCategory').value = agent ? agent.category : '';
            document.getElementById('agentFolder').value = agent ? agent.folder_name : '';
            document.getElementById('agentName').value = agent ? agent.name : '';
            document.getElementById('agentDescription').value = agent ? agent.description : '';
            document.getElementById('agentPrompt').value = agent ? agent.prompt : '';
            
            // Disable folder/category edit if editing
            document.getElementById('agentCategory').disabled = isEdit;
            document.getElementById('agentFolder').disabled = isEdit;
            
            renderSkillsCheckboxes(agent ? (agent.skills || []) : []);
            
            agentModal.show();
        }

        async function editAgent(category, name) {
            try {
                const res = await fetch(`/admin/agents/${category}/${name}`);
                const agent = await res.json();
                showAgentEditor(agent);
            } catch (e) { console.error(e); alert('Error fetching agent details'); }
        }

        async function editRootAgent() {
            try {
                const res = await fetch('/admin/agents/root');
                const agent = await res.json();
                showAgentEditor(agent);
            } catch (e) { console.error(e); alert('Error fetching root agent'); }
        }

        async function saveAgent() {
            const skillChecks = document.querySelectorAll('.skill-checkbox:checked');
            const skills = Array.from(skillChecks).map(c => c.value);

            const agentData = {
                category: document.getElementById('agentCategory').value.trim(),
                folder_name: document.getElementById('agentFolder').value.trim(),
                name: document.getElementById('agentName').value.trim(),
                description: document.getElementById('agentDescription').value.trim(),
                prompt: document.getElementById('agentPrompt').value.trim(),
                skills: skills
            };

            if (!agentData.category || !agentData.folder_name || !agentData.name || !agentData.prompt) {
                alert('Please fill in all required fields');
                return;
            }

            const url = agentData.category === 'root' ? '/admin/agents/root' : '/admin/agents';

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agentData)
                });
                const result = await res.json();
                if (result.success) {
                    agentModal.hide();
                    fetchAgents();
                } else {
                    alert('Error saving agent');
                }
            } catch (e) { console.error(e); alert('Error saving agent'); }
        }

        async function deleteAgent(category, name) {
            if (!confirm(`Are you sure you want to delete agent "${name}" in category "${category}"?`)) return;

            try {
                const res = await fetch(`/admin/agents/${category}/${name}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    fetchAgents();
                } else {
                    alert('Error deleting agent');
                }
            } catch (e) { console.error(e); alert('Error deleting agent'); }
        }

        function showChangePassword(username) {
            document.getElementById('targetUsername').innerText = username;
            document.getElementById('modalUsername').value = username;
            passwordModal.show();
        }

        
        async function togglePattern(username, enabled) {
            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('disabled', !enabled);
                const res = await fetch('/admin/user/toggle-pattern', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    const label = document.querySelector(`label[for="patternSwitch_${username}"]`);
                    if (label) label.textContent = enabled ? 'Enabled' : 'Disabled';
                } else {
                    alert('Failed to update');
                    document.getElementById(`patternSwitch_${username}`).checked = !enabled;
                }
            } catch (e) { console.error(e); alert('Error'); }
        }

        async function changeRole(username, newRole) {
            if (username === 'admin' && newRole === 'user') {
                alert('Cannot demote primary admin.');
                return;
            }
            if (!confirm(`Change role of user "${username}" to "${newRole}"?`)) return;

            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('role', newRole);
                const res = await fetch('/admin/user/toggle-role', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to update role');
                }
            } catch (e) { console.error(e); alert('Error'); }
        }

        async function deleteUser(username) {
            if (confirm(`Are you sure you want to delete user ${username}?`)) {
                const formData = new FormData();
                formData.append('username', username);
                const res = await fetch('/admin/user/remove', {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    location.reload();
                } else {
                    alert('Error deleting user');
                }
            }
        }

        async function syncPatterns() {
            const status = document.getElementById('sync-status');
            status.textContent = 'Syncing... Please wait.';
            status.className = 'small mt-2 text-info';
            
            try {
                const res = await fetch('/admin/patterns/sync', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    status.textContent = `Successfully synced ${data.count} patterns!`;
                    status.className = 'small mt-2 text-success';
                } else {
                    status.textContent = 'Error: ' + (data.error || 'Unknown error');
                    status.className = 'small mt-2 text-danger';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'small mt-2 text-danger';
            }
        }

        async function clearAllTags() {
            if (!confirm('Are you sure you want to CLEAR ALL chat tags? This cannot be undone.')) return;

            const status = document.getElementById('sync-status');
            status.textContent = 'Clearing tags...';
            status.className = 'small mt-2 text-info';
            
            try {
                const res = await fetch('/admin/sessions/cleartags', { method: 'POST' });
                if (!res.ok) throw new Error(`Server error ${res.status}`);
                const data = await res.json();
                if (data.success) {
                    status.textContent = `Successfully cleared tags from ${data.count} sessions!`;
                    status.className = 'small mt-2 text-success';
                } else {
                    status.textContent = 'Error: ' + (data.error || 'Unknown error');
                    status.className = 'small mt-2 text-danger';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'small mt-2 text-danger';
            }
        }

        async function updateLogLevel(level) {
            const status = document.getElementById('sync-status');
            try {
                const res = await fetch('/admin/system/log-level', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level })
                });
                if (res.ok) {
                    status.textContent = `Logging level updated to ${level}`;
                    status.className = 'small mt-2 text-success';
                    setTimeout(() => { status.textContent = ''; }, 3000);
                }
            } catch (e) { console.error(e); }
        }

        async function restartSetup() {
            if (confirm('Are you sure you want to RESTART SETUP? This will DELETE ALL USERS and you will need to re-configure the admin account.')) {
                try {
                    const res = await fetch('/admin/system/restart-setup', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        window.location.href = '/setup';
                    } else {
                        alert('Failed to restart setup');
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error');
                }
            }
        }
    </script>
</body>
</html>
